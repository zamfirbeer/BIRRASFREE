<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi ColecciÃ³n de Cervezas</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        deleteDoc,
        doc,
        updateDoc
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA8HtouyDiMEr7wYgIVjP-tNog9QAp5tZU",
        authDomain: "beerfree-e7dbb.firebaseapp.com",
        projectId: "beerfree-e7dbb",
        storageBucket: "beerfree-e7dbb.firebasestorage.app",
        messagingSenderId: "990167849390",
        appId: "1:990167849390:web:d0dc8fb5d263d07273503f"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // ðŸ”¥ hacemos Firestore global
      window.db = db;
      window.fb = {
        collection,
        getDocs,
        addDoc,
        deleteDoc,
        doc,
        updateDoc
      };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Iconos SVG inline
        const PlusIcon = () => (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        );
        const SearchIcon = () => (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        );
        const DownloadIcon = () => (
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        );
        const EditIcon = () => (
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        );
        const TrashIcon = () => (
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        );

        function BeerDatabase() {
          const [beers, setBeers] = useState([]);
          const [showForm, setShowForm] = useState(false);
          const [editingId, setEditingId] = useState(null);
          const [sqlQuery, setSqlQuery] = useState('');
          const [filteredBeers, setFilteredBeers] = useState([]);
          const [formData, setFormData] = useState({
            nombre: '',
            tipo: '',
            nacionalidad: '',
            color: '',
            observaciones: '',
            puntuacion: '',
            imagen: ''
          });

          useEffect(() => {
            const loadBeers = async () => {
              const snapshot = await window.fb.getDocs(window.fb.collection(window.db, "beers"));
              const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
              setBeers(data);
            };
            loadBeers();
          }, []);

          useEffect(() => { setFilteredBeers(beers); }, [beers]);

          const handleInputChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
          };

          const handleImageChange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => setFormData(prev => ({ ...prev, imagen: reader.result }));
              reader.readAsDataURL(file);
            }
          };

          const handleSubmit = async () => {
            if (!formData.nombre || !formData.tipo || !formData.nacionalidad || !formData.color || !formData.puntuacion) {
              alert('Por favor completa todos los campos obligatorios');
              return;
            }

            if (editingId) {
              await window.fb.updateDoc(window.fb.doc(window.db, "beers", editingId), formData);
              setEditingId(null);
            } else {
              await window.fb.addDoc(window.fb.collection(window.db, "beers"), formData);
            }

            // ðŸ”„ recargar cervezas
            const snapshot = await window.fb.getDocs(window.fb.collection(window.db, "beers"));
            setBeers(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));

            resetForm();
          };

          const resetForm = () => {
            setFormData({ nombre:'', tipo:'', nacionalidad:'', color:'', observaciones:'', puntuacion:'', imagen:'' });
            setShowForm(false);
          };

          const handleEdit = (beer) => {
            setFormData({ ...beer }); // incluye todos los campos
            setEditingId(beer.id);
            setShowForm(true);
          };

          const handleDelete = async (id) => {
            if (confirm('Â¿EstÃ¡s seguro de eliminar esta cerveza?')) {
              await window.fb.deleteDoc(window.fb.doc(window.db, "beers", id));
              setBeers(beers.filter(b => b.id !== id));
            }
          };

          const executeSQLQuery = () => {
            if (!sqlQuery.trim()) { setFilteredBeers(beers); return; }
            const query = sqlQuery.toLowerCase().trim();
            try {
              let result = [...beers];
              if (query.includes('where')) {
                const whereClause = query.split('where')[1].split('order by')[0].trim();
                result = beers.filter(beer => {
                  const conditions = whereClause.split('and').map(c => c.trim());
                  return conditions.every(condition => {
                    const likeMatch = condition.match(/(\w+)\s+like\s+['"]%(.+)%['"]/i);
                    const equalMatch = condition.match(/(\w+)\s*=\s*['"](.+)['"]/i);
                    const gtMatch = condition.match(/(\w+)\s*>\s*(\d+\.?\d*)/i);
                    const ltMatch = condition.match(/(\w+)\s*<\s*(\d+\.?\d*)/i);
                    if (likeMatch) { const [, f,v]=likeMatch; return beer[f]?.toLowerCase().includes(v.toLowerCase()); }
                    if (equalMatch) { const [, f,v]=equalMatch; return beer[f]?.toLowerCase()===v.toLowerCase(); }
                    if (gtMatch) { const [, f,v]=gtMatch; return parseFloat(beer[f])>parseFloat(v); }
                    if (ltMatch) { const [, f,v]=ltMatch; return parseFloat(beer[f])<parseFloat(v); }
                    return true;
                  });
                });
              }
              if (query.includes('order by')) {
                const orderClause = query.split('order by')[1].trim();
                const [field,direction]=orderClause.split(/\s+/);
                const isDesc = direction?.toLowerCase()==='desc';
                result.sort((a,b)=>{
                  const aVal=a[field]||'', bVal=b[field]||'';
                  if(!isNaN(aVal)&&!isNaN(bVal)) return isDesc?bVal-aVal:aVal-bVal;
                  return isDesc?bVal.toString().localeCompare(aVal.toString()):aVal.toString().localeCompare(bVal.toString());
                });
              }
              setFilteredBeers(result);
            } catch(e){ alert('Error en la consulta SQL. Verifica la sintaxis.'); }
          };

          const downloadData = () => {
            const dataStr = JSON.stringify(beers,null,2);
            const dataBlob = new Blob([dataStr],{type:'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href=url; link.download='mis_cervezas.json';
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          return (
            <div className="min-h-screen bg-amber-50 p-4">
              {/* ...todo tu JSX sigue igual, no cambia... */}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BeerDatabase />);
    </script>
</body>
</html>
